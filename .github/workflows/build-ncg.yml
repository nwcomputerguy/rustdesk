name: Build NCG Remote Access (Simple)

on:
  push:
    branches: [ main, master, ncg-1.4 ]
  workflow_dispatch:

env:
  RUST_VERSION: "1.75.0"
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C target-feature=+crt-static"

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc
        components: rustfmt
    
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: "v1-rust"
    
    - name: Install LLVM
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "16.0"
        directory: ${{ runner.temp }}/llvm
    
    - name: Set LIBCLANG_PATH
      shell: cmd
      run: echo LIBCLANG_PATH=${{ runner.temp }}/llvm/bin >> %GITHUB_ENV%
    
    - name: Build NCG Remote Access (No Audio)
      shell: cmd
      run: |
        echo Building NCG Remote Access without audio features...
        cargo build --release --no-default-features --features "use_rubato use_dasp" --verbose
    
    - name: Package NCG Remote
      shell: powershell
      run: |
        $output = "NCG-Remote-Portable"
        New-Item -ItemType Directory -Force -Path $output
        
        Copy-Item "target\release\rustdesk.exe" "$output\NCG-Remote-Access.exe"
        
        # Create config file
        @"
rendezvous_server = 'rust.northwoodscomputerguy.com:21116'
nat_type = 1
serial = 0

[options]
custom-rendezvous-server = 'rust.northwoodscomputerguy.com:21116'
key = 'sjVK2P8Cik7MW4v6sn1FhCN5RdRAK1BpqXlSDraF0qY='
relay-server = 'rust.northwoodscomputerguy.com:21117'
api-server = ''
"@ | Out-File -FilePath "$output\RustDesk2.toml" -Encoding UTF8
        
        # Create batch file
        @"
@echo off
title NCG Remote Access
color 0A
echo =======================================
echo    NCG Remote Access Tool
echo    Version 1.4.0
echo =======================================
echo.
echo Starting NCG Remote Access...
start "" "NCG-Remote-Access.exe"
echo.
echo Your ID will appear in the main window.
echo Share this ID with NCG support.
echo.
pause
"@ | Out-File -FilePath "$output\Start-NCG-Remote.bat" -Encoding ASCII
        
        Compress-Archive -Path "$output\*" -DestinationPath "NCG-Remote-Portable.zip" -Force
        Write-Host "Created NCG-Remote-Portable.zip"
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NCG-Remote-${{ github.run_number }}
        path: NCG-Remote-Portable.zip

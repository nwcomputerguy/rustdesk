name: Build NCG Remote Access

on:
  push:
    branches: [ main, master, ncg-1.4 ]
  workflow_dispatch:

env:
  RUST_VERSION: "1.75.0"
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C target-feature=+crt-static"

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc
        components: rustfmt
    
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: "v1-rust"
    
    - name: Install vcpkg
      shell: cmd
      run: |
        cd C:\
        git clone --depth=1 https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        bootstrap-vcpkg.bat
        vcpkg.exe integrate install
        vcpkg.exe install --triplet x64-windows-static opus
    
    - name: Install LLVM
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "16.0"
        directory: ${{ runner.temp }}/llvm
    
    - name: Set environment
      shell: cmd
      run: |
        echo VCPKG_ROOT=C:\vcpkg >> %GITHUB_ENV%
        echo LIBCLANG_PATH=${{ runner.temp }}/llvm/bin >> %GITHUB_ENV%
    
    - name: Build RustDesk
      shell: cmd
      run: cargo build --release --verbose
    
    - name: Package
      shell: cmd
      run: |
        mkdir NCG-Remote-Portable
        copy target\release\rustdesk.exe NCG-Remote-Portable\NCG-Remote-Access.exe
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NCG-Remote-${{ github.run_number }}
        path: NCG-Remote-Portable/

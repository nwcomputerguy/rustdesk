name: Download and Package NCG Remote

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  package:
    runs-on: windows-latest
    
    steps:
    - name: Setup
      shell: powershell
      run: |
        Write-Host "Creating NCG Remote Access package..."
        New-Item -ItemType Directory -Force -Path "NCG-Remote"
    
    - name: Download RustDesk
      shell: powershell
      run: |
        $url = "https://github.com/rustdesk/rustdesk/releases/download/1.4.0/rustdesk-1.4.0-x86_64.exe"
        Write-Host "Downloading from $url"
        Invoke-WebRequest -Uri $url -OutFile "NCG-Remote\NCG-Remote-Access.exe"
        
        $file = Get-Item "NCG-Remote\NCG-Remote-Access.exe"
        Write-Host "Downloaded: $($file.Name) - Size: $([math]::Round($file.Length / 1MB, 2)) MB"
    
    - name: Create Config
      shell: powershell
      run: |
        $config = @"
rendezvous_server = 'rust.northwoodscomputerguy.com:21116'
nat_type = 1
serial = 0

[options]
custom-rendezvous-server = 'rust.northwoodscomputerguy.com:21116'
key = 'sjVK2P8Cik7MW4v6sn1FhCN5RdRAK1BpqXlSDraF0qY='
relay-server = 'rust.northwoodscomputerguy.com:21117'
api-server = ''
"@
        $config | Out-File -FilePath "NCG-Remote\RustDesk2.toml" -Encoding UTF8
        Write-Host "Created config file"
    
    - name: Create Launcher
      shell: powershell
      run: |
        $launcher = @"
@echo off
title NCG Remote Access
color 0A
echo =======================================
echo    NCG Remote Access Tool v1.4.0
echo =======================================
echo.
echo Starting NCG Remote Access...
start "" "NCG-Remote-Access.exe"
echo.
echo Your ID will appear in the main window.
echo Server: rust.northwoodscomputerguy.com
echo.
pause
"@
        $launcher | Out-File -FilePath "NCG-Remote\Start-NCG-Remote.bat" -Encoding ASCII
        Write-Host "Created launcher"
    
    - name: Create ZIP
      shell: powershell
      run: |
        Compress-Archive -Path "NCG-Remote\*" -DestinationPath "NCG-Remote-Portable.zip" -Force
        Write-Host "Created NCG-Remote-Portable.zip"
    
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: NCG-Remote-Portable
        path: NCG-Remote-Portable.zip
    
    - name: Create Release
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ncg-${{ github.run_number }}
        name: NCG Remote v1.4.0.${{ github.run_number }}
        body: |
          # NCG Remote Access
          
          Ready-to-use package with NCG server configuration.
          
          **Download:** NCG-Remote-Portable.zip
          
          Extract and run Start-NCG-Remote.bat
        files: NCG-Remote-Portable.zip
        draft: false
        prerelease: false
